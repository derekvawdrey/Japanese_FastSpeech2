
def preprocess_japanese(text, preprocess_config):
    lexicon_path = preprocess_config["path"].get("lexicon_path")
    lexicon = read_lexicon(lexicon_path) if lexicon_path else {}

    g2p_result = pyopenjtalk.g2p(text)
    tokens = [token for token in g2p_result.split(" ") if token]

    phones = []
    for token in tokens:
        # Handle pauses explicitly to align with FastSpeech conventions.
        if token in {"pau", "sil"}:
            phones.append("sp")
            continue

        lookup_keys = (token, token.lower())
        mapped = False
        for key in lookup_keys:
            if key in lexicon:
                phones += lexicon[key]
                mapped = True
                break
        if not mapped:
            phones.append(token)

    phones = "{" + " ".join(phones) + "}"
    print("Raw Text Sequence: {}".format(text))
    print("Phoneme Sequence: {}".format(phones))
    sequence = np.array(
        text_to_sequence(
            phones, preprocess_config["preprocessing"]["text"]["text_cleaners"]
        )
    )

    return np.array(sequence)